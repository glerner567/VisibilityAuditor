<!DOCTYPE html><html><head><meta charset='utf-8'></head><body style='margin:0;padding:20px;font-family:sans-serif;background:#f4f7f6;color:#333;'><div style='max-width:1000px;margin:0 auto;background:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);'><h2 style='margin-top:0;color:#2c3e50;'>Security & Visibility Auditor v1.6</h2><p style='color:#666;font-size:14px;'>Now listing specific asset names with direct links to vehicle pages.</p><div id='loading-overlay' style='display:none;padding:10px;background:#fff9c4;border:1px solid #fbc02d;margin-bottom:15px;border-radius:4px;'>Loading hierarchy & assets...</div><div style='margin-bottom:20px;'><label style='font-weight:bold;'>Select User to Audit:</label><select id='user-select' style='width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:4px;'><option value=''>-- Choose a User --</option></select></div><div id='results-area' style='display:none;'><div style='display:grid;grid-template-columns:1fr 1fr;gap:20px;'><div style='background:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #3498db;'><h4 style='margin-top:0;'>Assets & Users They See</h4><div id='asset-summary' style='font-weight:bold;margin-bottom:10px;color:#2980b9;'></div><div id='asset-container' style='max-height:200px;overflow-y:auto;background:#fff;border:1px solid #eee;padding:10px;margin-bottom:15px;border-radius:4px;'><ul id='asset-names-list' style='font-size:12px;padding-left:15px;margin:0;line-height:1.8;'></ul></div><hr style='border:0;border-top:1px solid #eee;margin:15px 0;'><h5 style='margin-bottom:5px;'>Visible Users:</h5><ul id='can-see-list' style='font-size:13px;padding-left:20px;line-height:1.6;'></ul></div><div style='background:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #e67e22;'><h4 style='margin-top:0;'>Users Who Can See Them</h4><ul id='seen-by-list' style='font-size:13px;padding-left:20px;line-height:1.6;'></ul></div></div></div><div id='empty-state' style='text-align:center;padding:40px;color:#999;'>Select a user to analyze visibility.</div></div><div id='debug-toggle' style='position:fixed;bottom:0;left:0;right:0;text-align:center;'><button onclick='var d=document.getElementById(\"debug-log\");d.style.display=d.style.display===\"none\"?\"block\":\"none\";' style='background:#e74c3c;color:#fff;border:none;padding:4px 16px;cursor:pointer;font-size:12px;border-radius:4px 4px 0 0;'>Toggle Debug Log</button><button onclick='copyDebugData()' style='background:#f39c12;color:#fff;border:none;padding:4px 16px;cursor:pointer;font-size:12px;border-radius:4px 4px 0 0;margin-left:4px;'>Copy Debug Data</button><pre id='debug-log' style='display:none;background:#1e1e1e;color:#0f0;padding:10px;margin:0;max-height:200px;overflow-y:auto;text-align:left;font-size:11px;'></pre></div><script>var _debugData={};function debugLog(msg){var el=document.getElementById('debug-log');if(el){el.textContent+='['+new Date().toLocaleTimeString()+'] '+msg+'\\n';}}function debugSample(k,a){_debugData[k]={total:a.length,sample:a.slice(0,10)};}function copyDebugData(){var t=document.createElement('textarea');t.value=JSON.stringify(_debugData,null,2);document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);alert('Copied! Paste to chat.');}geotab.addin['visibility-auditor-v16']=function(){var _users=[],_groups=[],_devices=[],_groupMap={};function isSystemAccount(u){var name=(u.name||u.userName||'').toLowerCase();return name.indexOf('myadmin')===0||u.isAutoAdded===true;}function getFriendlyName(u){if(!u)return'Unknown User';var name=u.firstName||'';if(u.lastName)name+=' '+u.lastName;if(!name.trim())name=u.userName||u.name||'Unnamed User';return name;}function buildGroupTree(groupId,list){if(list.indexOf(groupId)>-1)return list;list.push(groupId);var g=_groupMap[groupId];if(g&&g.children){for(var i=0;i<g.children.length;i++){buildGroupTree(g.children[i].id,list);}}return list;}return{initialize:function(api,state,callback){document.getElementById('loading-overlay').style.display='block';api.multiCall([['Get',{typeName:'User'}],['Get',{typeName:'Group'}],['Get',{typeName:'Device'}]],function(results){_users=results[0].filter(function(u){return!isSystemAccount(u);});_groups=results[1];_devices=results[2];_groups.forEach(function(g){_groupMap[g.id]=g;});debugSample('users',_users);var select=document.getElementById('user-select');_users.sort(function(a,b){return getFriendlyName(a).localeCompare(getFriendlyName(b));}).forEach(function(u){var opt=document.createElement('option');opt.value=u.id;opt.textContent=getFriendlyName(u);select.appendChild(opt);});document.getElementById('loading-overlay').style.display='none';select.onchange=function(){var uid=this.value;if(!uid){document.getElementById('results-area').style.display='none';return;}document.getElementById('empty-state').style.display='none';document.getElementById('results-area').style.display='block';var targetUser=_users.find(function(x){return x.id===uid;});var targetGroupIds=(targetUser.companyGroups||[]).map(function(g){return g.id;});var targetCanSeeIds=[];targetGroupIds.forEach(function(gid){buildGroupTree(gid,targetCanSeeIds);});var assetList=document.getElementById('asset-names-list');var canSeeList=document.getElementById('can-see-list');var seenByList=document.getElementById('seen-by-list');assetList.innerHTML='';canSeeList.innerHTML='';seenByList.innerHTML='';var visDevs=_devices.filter(function(d){return(d.groups||[]).some(function(dg){return targetCanSeeIds.indexOf(dg.id)>-1;});});document.getElementById('asset-summary').textContent='Visible Assets ('+visDevs.length+')';visDevs.sort(function(a,b){return(a.name||'').localeCompare(b.name||'');}).forEach(function(dev){var li=document.createElement('li');var link=document.createElement('a');link.textContent=dev.name||'Unnamed Device ('+dev.id+')';link.style.cssText='color:#2563eb;cursor:pointer;text-decoration:underline;';link.onclick=function(e){e.preventDefault();window.parent.location.hash='#device,id:'+dev.id;};li.appendChild(link);assetList.appendChild(li);});_users.forEach(function(u){var uGroups=(u.companyGroups||[]).map(function(g){return g.id;});var uCanSeeIds=[];uGroups.forEach(function(gid){buildGroupTree(gid,uCanSeeIds);});var uCanSeeTarget=targetGroupIds.some(function(tgid){return uCanSeeIds.indexOf(tgid)>-1;});if(uCanSeeTarget){var li=document.createElement('li');li.textContent=getFriendlyName(u)+(u.id===uid?' (Self)':'');seenByList.appendChild(li);}var targetCanSeeU=uGroups.some(function(ugid){return targetCanSeeIds.indexOf(ugid)>-1;});if(targetCanSeeU&&u.id!==uid){var li=document.createElement('li');li.textContent=getFriendlyName(u);canSeeList.appendChild(li);}});};},function(err){debugLog('Error: '+err);});callback();}};};</script></body></html>"
